<div><a href="/">Home</a></div>
<h1>{{title}}</h1>
<div class="loading" id="loading-button">Loading paypal button...</div>
<div id="paypal-button-container"></div>
<div id="paypal-result-container"></div>
{{!-- PP Rest API simple --}}
{{!-- client-id=AeGY.. #App: MerchantApp | Account: eran.m.il@merchant.com (BusinessPro) --}}

<div id="pp-ba-approve-result">
  <p>Details</p>
  <p>EC Token: <span id="ec-token-container">{{ec_token}}</span></p>
  <p>Billing Agreement Token: <span id="ba-id-container">{{ba_token}}</span></p>
<p><button id="ba-generate" onclick="generateBa()">Generate BA</button></p>
<p>Billing agreement Create Result:</p>
<p id="ba-response"></p>
<hr>

<script
  src="https://www.paypal.com/sdk/js?client-id=AeGYWEKwAbpNAOQaBkUyNXAalNwEZ5ialX-niqRbbcdZkLY8t-YuOMBLhDJUTP1JWKmJMMCFAeOWUSzF&currency=USD&components=buttons">
  </script>

<script>
  var globalAccessToken = "";
  var globalClientToken = "";
  var baTokenId = "";
  var baId = "";

  $("#loading-button").show();
  paypal.Buttons({

    // Sets up the transaction when a payment button is clicked
    createOrder: function (data, actions) {

      $.ajax('ppapi/rt/flow/start', {
        type: 'POST',
        data: {},
        success: function (data, status, xhr) {
          console.log(data);
          const approvalUrl = data.links.find(l => l.rel == 'approval_url').href;
          if (approvalUrl) {
            window.open(approvalUrl);
          }

        },
        error: function (jqXhr, textStatus, errorMessage) {
          console.log(errorMessage);
        }
      });

    }
  }).render('#paypal-button-container').then(function () {
    $("#loading-button").hide();
  });


  function generateBa() {
    $.ajax('/ppapi/rt/flow/create-billing-agreement', {
      type: 'POST',
      data: { token_id: baTokenId },
      success: function (data, status, xhr) {
        console.log(data);
        $("#ba-response").html(JSON.stringify(data));
        
      },
      error: function (jqXhr, textStatus, errorMessage) {
        console.log(errorMessage);
      }
    });

  }

  // return url after user approve BA
  // http://localhost:3000/ppcort?token=EC-4H4952447G899934X&ba_token=BA-65L40004CN2398355
  const spanEcToken = $("#ec-token-container");
  const spanBaToken = $("#ba-id-container");
  if (spanEcToken.text().length > 0) {
    $("#pp-ba-approve-result").css('visibility', 'visible');
    baTokenId = spanBaToken.text();
  }
  else {
    $("#pp-ba-approve-result").css('visibility', 'hidden');
  }

</script>
