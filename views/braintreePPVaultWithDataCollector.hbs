<div><a href="/">Home</a></div>
<h1>{{title}}</h1>
<hr>
<!---------------- Paypal Button ------------------>
<div>
  <div id="paypal-button"></div>
</div>


<div>
  {{!-- <button id="generate-token">Generate Access Token</button> --}}
  <div class="loading" id="loading-token">Generating access token...</div>
  <div style="inline-size: 1350px;overflow-wrap: break-word; ">
    <p>Access token: </p>
    <div id="token" style="font-size: 6pt;"></div>
  </div>


  <div class="loading" id="loading-button">Loading paypal button...</div>

</div>
<div style="inline-size: 1350px;overflow-wrap: break-word; ">
  <p>OnApprove payload: </p>
  <div id="approve-payload">&nbsp;</div>
</div>

<div style="inline-size: 1350px;overflow-wrap: break-word; ">
  <p>Checkout Server message: </p>
  <div id="checkout-message">&nbsp;</div>
</div>

<div style="inline-size: 1350px;overflow-wrap: break-word; ">
  <p>Checkout Server result: </p>
  <div id="checkout-result">&nbsp;</div>
</div>

<!-- includes the Braintree JS client SDK -->
<!-- Load the client component. -->
<script src="https://js.braintreegateway.com/web/3.85.2/js/client.min.js"></script>

<!-- Load the PayPal Checkout component. -->
<script src="https://js.braintreegateway.com/web/3.85.2/js/paypal-checkout.min.js"></script>


<!-- Load the PayPal JS SDK with your PayPal Client ID-->
{{!-- client-id=AbfWH.. #App: ACDC | Account: eran.m.us@merchant.com (BusinessPro) --}}
<script
  src="https://www.paypal.com/sdk/js?client-id=AbfWHDmsApd4IM7TDiLYpsjH28utsEt-XfxVOxnE9SKbtSziPLp_LhMToOKgVKjXR7BVhDw6Pvw89ALk">
  </script>
<script src="https://js.braintreegateway.com/web/3.85.2/js/data-collector.min.js"></script>
<script>
  // -----------------------------------------------------------------
  // client server example
  // -----------------------------------------------------------------
  var tokenSpan = document.querySelector('#token')
  var token = undefined;
  // get access token
  (function () {
    $.ajax({
      type: 'GET',
      url: '/bt/hf/payment/client_token'
    }).done(function (result) {
      // console.log(result);
      token = result;
      tokenSpan.innerHTML = `${token}`;
      $("#loading-token").hide();

      initBtVaultCheckout(token);

    });


  }());

  // -----------------------------------------------------------------

  // Vault checkout
  var client = undefined;
  function initBtVaultCheckout(token) {
    $("#loading-button").show();

    // Create a client.
    braintree.client.create({
      authorization: token
    }).then(function (clientInstance) {
      client = clientInstance;
      return braintree.dataCollector.create({
        client: clientInstance,
      });
    }).then(function (dataCollectorInstance) {
      // At this point, you should access the dataCollectorInstance.deviceData value and provide it
      // to your server, e.g. by injecting it into your form as a hidden input
      myDeviceData = dataCollectorInstance.deviceData;
      console.log("deviceData:", JSON.stringify(myDeviceData));

      // Create a PayPal Checkout component.
      return braintree.paypalCheckout.create({
        client: client
      });
    }).then(function (paypalCheckoutInstance) {
      return paypalCheckoutInstance.loadPayPalSDK({
        vault: true
      });
    }).then(function (paypalCheckoutInstance) {
      $("#loading-button").hide();
      return paypal.Buttons({
        fundingSource: paypal.FUNDING.PAYPAL,

        createBillingAgreement: function () {
          return paypalCheckoutInstance.createPayment({
            flow: 'vault', // Required

            // The following are optional params
            billingAgreementDescription: 'Your agreement description',
            enableShippingAddress: true,
            shippingAddressEditable: false,
            shippingAddressOverride: {
              recipientName: 'Scruff McGruff',
              line1: '1234 Main St.',
              line2: 'Unit 1',
              city: 'Chicago',
              countryCode: 'US',
              postalCode: '60652',
              state: 'IL',
              phone: '123.456.7890'
            }
          });
        },

        onApprove: function (data, actions) {
          return paypalCheckoutInstance.tokenizePayment(data).then(function (payload) {
            // Submit `payload.nonce` to your server
            console.log("Here you call the merchant API payment endpoint with the payload.nonce");

            $.ajax({
              type: 'POST',
              url: '/bt/vault/payment/vault',
              data: {
                'paymentMethodNonce': payload.nonce,
                'amount': '55.00',
                'deviceData': myDeviceData                

              }
            }).done(function (result) {

              if (result.success) {
                var approveDiv = document.querySelector('#approve-payload');
                approveDiv.innerHTML = JSON.stringify(payload);
                
                $('#checkout-message').html('<h1>Success</h1><p>Vault Checkout is working! Check your <a href="https://sandbox.braintreegateway.com/login">sandbox Control Panel</a> for your test transactions.</p><p>Refresh to try another transaction.</p><p><a href="/">Home</a></p>');

                 var serverResultDiv = document.querySelector('#checkout-result');
                // serverResultDiv.innerHTML = JSON.stringify(result);
                $("#checkout-result").jsonViewer(result);
              } else {
                // console.log(result);
                $('#checkout-message').html('<h1>Error</h1><p>Check your console.</p>');
              }
            });



          });
        },

        onCancel: function (data) {
          console.log('PayPal payment canceled', JSON.stringify(data, 0, 2));
        },

        onError: function (err) {
          console.error('PayPal error', err);
        }
      }).render('#paypal-button');
    }).then(function () {
      // The PayPal button will be rendered in an html element with the ID
      // `paypal-button`. This function will be called when the PayPal button
      // is set up and ready to be used
      console.log("Checkout button render completed");
    }).catch(function (err) {
      // Handle component creation error
    });
  }






</script>